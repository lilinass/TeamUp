<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/png" href="./Images/Logo v2.png" />
  <title>Koordy â€” Mon Profil</title>
</head>

<body>

<!-- ðŸ”µ HEADER identique Ã  home_association -->
<header class="site-header">
  <div class="container site-header__inner">

    <a href="/" class="brand">
      <img src="./Images/Logo v2.png" class="brand__logo" />
      <span class="brand__name">Koordy</span>
    </a>

    <nav class="nav">
      <ul class="nav__list">
        <li><a href="/home_association" class="nav__link">Accueil</a></li>
        <li><a href="/association" class="nav__link">Association</a></li>
        <li><a href="/events_page" class="nav__link">Ã‰vÃ¨nements</a></li>
        <li><a href="#" class="nav__link">ActualitÃ©s</a></li>
        <li><a href="#" class="nav__link">Contact</a></li>
      </ul>
    </nav>

    <div id="user-badge" class="nav__btns"></div>

  </div>
</header>

<main class="container" style="padding: 50px 0;">

  <h1 class="section__title section__title--line">Mon Profil</h1>

  <!-- BOUTON MODIFICATION -->
  <div style="display:flex; justify-content:flex-end; margin:10px 0;">
    <button id="editProfileBtn" class="btn btn--primary">Modifier mon profil</button>
  </div>

  <!-- PROFIL -->
  <div class="card" style="padding: 28px;">
    <div id="profil-content">Chargement du profil...</div>
  </div>

  <!-- ASSOCIATION -->
  <h2 class="section__title" style="margin-top:40px;">Mon Association</h2>
  <div id="association-section" class="card" style="padding:22px;">
    Chargement de l'association...
  </div>
  <h2 class="section__title" style="margin-top:40px;">Mon Ã©quipe</h2>
<div id="team-section" class="card" style="padding:22px;">
    Chargement de l'Ã©quipe...
</div>


  <!-- ACTIVITÃ‰S -->
  <h2 class="section__title" style="margin-top:40px;">Mes activitÃ©s</h2>
  <div id="dashboard" class="card" style="padding:22px;">
    Chargement des activitÃ©s...
  </div>

</main>

<!-- MODAL EDIT -->
<div id="editModal" class="modal hidden">
  <div class="modal-content">
    <h2>Modifier mon profil</h2>

    <form id="editProfileForm" class="tt-form">

      <label>PrÃ©nom</label>
      <input id="edit-prenom" type="text"/>

      <label>Nom</label>
      <input id="edit-nom" type="text"/>

      <label>Email</label>
      <input id="edit-email" type="email"/>

      <label>Date de naissance</label>
      <input id="edit-birth" type="date"/>

      <button type="submit" class="btn btn--primary">Enregistrer</button>
      <button type="button" class="btn btn--ghost" id="closeModal">Annuler</button>

    </form>
  </div>
</div>



<script>

/* ===========================================================
   ðŸ”µ Charger le profil du membre
=========================================================== */
async function loadProfil() {
  const id = localStorage.getItem("id_membre");

  if (!id) {
    document.getElementById("profil-content").innerHTML =
      "<p>Aucun utilisateur connectÃ©.</p>";
    return;
  }

  const res = await fetch(`http://localhost:8080/api/membre/${id}`);
  const data = await res.json();

  /* ================================================================
      ðŸ”µ FORMATTAGE DE LA DATE (remet juste JJ/MM/AAAA)
  ================================================================= */
  let formattedBirth = "â€”";
  if (data.date_naissance) {
    const d = new Date(data.date_naissance);
    formattedBirth = d.toLocaleDateString("fr-FR");  // EX : 20/05/1999
  }

  /* ================================================================
      ðŸ”µ RECALCUL DE L'Ã‚GE CÃ”TÃ‰ FRONT (pour Ãªtre sÃ»r)
  ================================================================= */
  let age = "â€”";
  if (data.date_naissance) {
    const birthYear = new Date(data.date_naissance).getFullYear();
    age = new Date().getFullYear() - birthYear;
  }

  // ðŸ”µ Affichage du prÃ©nom en haut
  document.getElementById("user-badge").innerHTML =
    `<span class="btn btn--ghost">Bienvenue, ${data.prenom_membre}</span>`;

  // ðŸ”µ Remplir le profil
  document.getElementById("profil-content").innerHTML = `
    <p><strong>Nom :</strong> ${data.nom_membre}</p>
    <p><strong>PrÃ©nom :</strong> ${data.prenom_membre}</p>
    <p><strong>Email :</strong> ${data.mail_membre}</p>
    <p><strong>Date de naissance :</strong> ${formattedBirth}</p>
    <p><strong>Ã‚ge :</strong> ${age} ans</p>
    <p><strong>RÃ´le dans l'association :</strong> ${data.role_asso || "Membre"}</p>
    <p><strong>Date dâ€™adhÃ©sion :</strong> ${
      data.date_adhesion
        ? new Date(data.date_adhesion).toLocaleDateString("fr-FR")
        : "â€”"
    }</p>
  `;

  populateModal(data);
}



/* ===========================================================
   ðŸ”µ Charger lâ€™association du membre
=========================================================== */
async function loadAssociationForProfile() {
  const id = localStorage.getItem("id_membre");

  const res = await fetch(`http://localhost:8080/api/membre/${id}/association`);
  const data = await res.json();

  const section = document.getElementById("association-section");

  if (!data.nom) {
    section.innerHTML = "<p>Aucune association trouvÃ©e.</p>";
    return;
  }

  section.innerHTML = `
    <p><strong>Nom :</strong> ${data.nom}</p>
    <p><strong>Sport :</strong> ${data.sport}</p>
    <p><strong>Ville :</strong> ${data.ville}</p>
  `;
}



/* ===========================================================
   ðŸ”µ Modifier mon profil â€” PUT
=========================================================== */
document.getElementById("editProfileForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const id = localStorage.getItem("id_membre");

  const payload = {
    prenom: document.getElementById("edit-prenom").value,
    nom: document.getElementById("edit-nom").value,
    email: document.getElementById("edit-email").value,
    birthday: document.getElementById("edit-birth").value
  };

  const res = await fetch(`http://localhost:8080/api/membre/${id}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  if (!res.ok) return alert("Erreur lors de la mise Ã  jour");

  alert("âœ” Profil mis Ã  jour !");
  location.reload();
});


/* ===========================================================
   ðŸ”µ PrÃ©remplir le modal
=========================================================== */
function populateModal(data) {
  document.getElementById("edit-prenom").value = data.prenom_membre;
  document.getElementById("edit-nom").value = data.nom_membre;
  document.getElementById("edit-email").value = data.mail_membre;
  document.getElementById("edit-birth").value = data.date_naissance || "";
}



/* ===========================================================
   ðŸ”µ Dashboard activitÃ©s
=========================================================== */
async function loadDashboard() {
  const id = localStorage.getItem("id_membre");
  const res = await fetch(`http://localhost:8080/api/membre/${id}/presences`);
  const data = await res.json();

  if (!data.length) {
    document.getElementById("dashboard").innerHTML = "<p>Aucune activitÃ©.</p>";
    return;
  }

  let presents = data.filter(d => d.statut === "prÃ©sent").length;
  let taux = Math.round((presents / data.length) * 100);

  let html = `<p><strong>Taux de prÃ©sence :</strong> ${taux}%</p><ul>`;
  data.forEach(a => {
    html += `<li><strong>${a.nom_activite}</strong> â€” ${a.statut} â€” ${a.date_presence}</li>`;
  });
  html += "</ul>";

  document.getElementById("dashboard").innerHTML = html;
}
async function loadTeamForProfile() {
  const id = localStorage.getItem("id_membre");

  const res = await fetch(`http://localhost:8080/api/membre/${id}/equipes`);
  const equipes = await res.json();

  const section = document.getElementById("team-section");

  if (!equipes || equipes.length === 0) {
    section.innerHTML = "<p>Aucune Ã©quipe trouvÃ©e.</p>";
    return;
  }

  const e = equipes[0]; // premiÃ¨re Ã©quipe trouvÃ©e

  section.innerHTML = `
    <p><strong>Ã‰quipe :</strong> ${e.nom_equipe}</p>
    <p><strong>RÃ´le :</strong> ${e.role}</p>
  `;
}




/* ===========================================================
   ðŸ”µ GÃ©rer l'ouverture / fermeture du modal
=========================================================== */
document.getElementById("editProfileBtn").addEventListener("click", () => {
  document.getElementById("editModal").classList.remove("hidden");
});
document.getElementById("closeModal").addEventListener("click", () => {
  document.getElementById("editModal").classList.add("hidden");
});


/* ===========================================================
   ðŸš€ Charger la totalitÃ© de la page
=========================================================== */
loadProfil();
loadAssociationForProfile();
loadTeamForProfile();
loadDashboard();

</script>

</body>
</html>
